# nats.net

url : https://github.com/nats-io/nats.net

## 버퍼 사이즈 limit

payload 버퍼 운용에 limit가 있다.

#### 서버 limit:

default로 서버를 실행하면 `"max_payload": 1048576`, 1메가로 잡힌다. 웹 프론트엔드의 `/varz` 에서 확인할 수 있다.

#### 클라이언트 limit:

```csharp
class NatsOpts
    public int WriterBufferSize { get; init; } = 65536;
    public int ReaderBufferSize { get; init; } = 65536;
```

기본 65kb 사이즈로 제한이 걸린다. 더 큰 데이터를 보내려면 client 객체를 생성할 때 option에서 조정해주어야 하는데, 접속하는 서버의 payload limit을 넘어서게 설정할 수는 없다.

## send할 때 직렬화 2회 실행

사이즈를 얻어내기 위해 버퍼에 공회전을 한 번 친다. 낭비다....

```csharp
// NatsOpts.cs의 Serializer 속성 주석 참고.

/// <summary>
/// Serializer to use for the calculate data size.
/// </summary>
/// <remarks>This results in double serialization: once for size calculation, once when publishing.</remarks>
public INatsSerializer<T>? Serializer { get; set; }
```

```csharp
// src\NATS.Client.Core\NatsMsg.cs의 NatsMsgBuilder<T>.Msg 속성에서
if (Serializer != null && Data != null)
{
    var bufferWriter = new NatsPooledBufferWriter<byte>(SerializationBufferSize);
    Serializer.Serialize(bufferWriter, Data);  // 여기서 첫 번째 직렬화가 일어남 (사이즈 계산용)
    size = bufferWriter.WrittenMemory.Length;
}
```

```csharp
// src\NATS.Client.Core\Commands\CommandWriter.cs의 PublishAsync 메서드에서
if (value != null)
    serializer.Serialize(payloadBuffer, value);  // 여기서 두 번째 직렬화가 일어남 (실제 전송용)
```